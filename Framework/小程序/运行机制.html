<!DOCTYPE html>
<html lang="zh-US">
  <head>
    <link rel="manifest" href="/blog/manifest.webmanifest"><title>运行机制 | Johnny's blog</title><meta name="description" content="认真分享和记录各类好文，逐步完善大前端知识体系。"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="VuePress 2.0.0-beta.22">
    <link rel="preload" href="/blog/assets/js/runtime~app.5b40ce10.js" as="script"><link rel="preload" href="/blog/assets/css/styles.678e5aee.css" as="style"><link rel="preload" href="/blog/assets/js/981.9765ac40.js" as="script"><link rel="preload" href="/blog/assets/js/app.3e27996d.js" as="script">
    <link rel="stylesheet" href="/blog/assets/css/styles.678e5aee.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><header class="navbar"><div class="toggle-sidebar-button"><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><span><a href="/blog/" class=""><!----><span class="site-name">Johnny&#39;s blog</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/blog/JavaScript/" class="nav-link" aria-label="深入JavaScript"><!--[--><!--]--> 深入JavaScript <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/Network/" class="nav-link" aria-label="计算机网络"><!--[--><!--]--> 计算机网络 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/Browser/" class="nav-link" aria-label="浏览器相关"><!--[--><!--]--> 浏览器相关 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/Framework/" class="nav-link router-link-active" aria-label="框架和类库"><!--[--><!--]--> 框架和类库 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/Engineering/" class="nav-link" aria-label="前端工程化"><!--[--><!--]--> 前端工程化 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/NewTechnology/" class="nav-link" aria-label="新技术/方向"><!--[--><!--]--> 新技术/方向 <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://hezhuoyi.github.io/leetcode" rel="noopener noreferrer" target="_blank" aria-label="LeetCode"><!--[--><!--]--> LeetCode <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/hezhuoyi" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://juejin.cn/user/3597257778155703" rel="noopener noreferrer" target="_blank" aria-label="掘金"><!--[--><!--]--> 掘金 <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="Search" autocomplete="off" spellcheck="false" value><!----></form></div></header><div class="sidebar-mask"></div><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/blog/JavaScript/" class="nav-link" aria-label="深入JavaScript"><!--[--><!--]--> 深入JavaScript <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/Network/" class="nav-link" aria-label="计算机网络"><!--[--><!--]--> 计算机网络 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/Browser/" class="nav-link" aria-label="浏览器相关"><!--[--><!--]--> 浏览器相关 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/Framework/" class="nav-link router-link-active" aria-label="框架和类库"><!--[--><!--]--> 框架和类库 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/Engineering/" class="nav-link" aria-label="前端工程化"><!--[--><!--]--> 前端工程化 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/NewTechnology/" class="nav-link" aria-label="新技术/方向"><!--[--><!--]--> 新技术/方向 <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://hezhuoyi.github.io/leetcode" rel="noopener noreferrer" target="_blank" aria-label="LeetCode"><!--[--><!--]--> LeetCode <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/hezhuoyi" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://juejin.cn/user/3597257778155703" rel="noopener noreferrer" target="_blank" aria-label="掘金"><!--[--><!--]--> 掘金 <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item active">框架和类库</p><ul class=""><li><!--[--><a href="/blog/Framework/" class="nav-link router-link-active sidebar-item" aria-label="概览"><!--[--><!--]--> 概览 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><p class="sidebar-item">Vue</p><ul class="sidebar-sub-items"><li><!--[--><a href="/blog/Framework/Vue/Vue%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86.html" class="nav-link sidebar-item" aria-label="Vue实现原理"><!--[--><!--]--> Vue实现原理 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/Framework/Vue/Vue%E6%BA%90%E7%A0%81%E7%9B%B8%E5%85%B3.html" class="nav-link sidebar-item" aria-label="Vue源码相关"><!--[--><!--]--> Vue源码相关 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/Framework/Vue/Vuex%E5%92%8CVue-Router.html" class="nav-link sidebar-item" aria-label="Vuex和Vue-Router"><!--[--><!--]--> Vuex和Vue-Router <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/Framework/Vue/Vue3%E7%9A%84%E4%BC%98%E5%8C%96.html" class="nav-link sidebar-item" aria-label="Vue3的优化"><!--[--><!--]--> Vue3的优化 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">React</p><ul class="sidebar-sub-items"><li><!--[--><a href="/blog/Framework/React/Fiber.html" class="nav-link sidebar-item" aria-label="Fiber"><!--[--><!--]--> Fiber <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/Framework/React/Hooks.html" class="nav-link sidebar-item" aria-label="Hooks"><!--[--><!--]--> Hooks <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/Framework/React/Redux.html" class="nav-link sidebar-item" aria-label="Redux"><!--[--><!--]--> Redux <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/Framework/React/React%E5%85%B6%E4%BB%96.html" class="nav-link sidebar-item" aria-label="React其他"><!--[--><!--]--> React其他 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">TypeScript</p><ul class="sidebar-sub-items"><li><!--[--><a href="/blog/Framework/TypeScript/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3TS.html" class="nav-link sidebar-item" aria-label="深入理解TS"><!--[--><!--]--> 深入理解TS <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/Framework/TypeScript/TS%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F.html" class="nav-link sidebar-item" aria-label="TS 类型系统"><!--[--><!--]--> TS 类型系统 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/Framework/TypeScript/%E5%B7%A7%E7%94%A8TypeScript.html" class="nav-link sidebar-item" aria-label="巧用TypeScript"><!--[--><!--]--> 巧用TypeScript <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item active">小程序</p><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/blog/Framework/%E5%B0%8F%E7%A8%8B%E5%BA%8F/%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6.html" class="router-link-active router-link-exact-active nav-link router-link-active sidebar-item active" aria-label="运行机制"><!--[--><!--]--> 运行机制 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/blog/Framework/%E5%B0%8F%E7%A8%8B%E5%BA%8F/%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6.html#一、技术选型" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="一、技术选型"><!--[--><!--]--> 一、技术选型 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blog/Framework/%E5%B0%8F%E7%A8%8B%E5%BA%8F/%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6.html#二、双线程模型" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="二、双线程模型"><!--[--><!--]--> 二、双线程模型 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blog/Framework/%E5%B0%8F%E7%A8%8B%E5%BA%8F/%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6.html#三、双线程通信" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="三、双线程通信"><!--[--><!--]--> 三、双线程通信 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blog/Framework/%E5%B0%8F%E7%A8%8B%E5%BA%8F/%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6.html#四、运行机制" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="四、运行机制"><!--[--><!--]--> 四、运行机制 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blog/Framework/%E5%B0%8F%E7%A8%8B%E5%BA%8F/%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6.html#五、性能优化" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="五、性能优化"><!--[--><!--]--> 五、性能优化 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a href="/blog/Framework/%E5%B0%8F%E7%A8%8B%E5%BA%8F/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html" class="nav-link sidebar-item" aria-label="性能优化"><!--[--><!--]--> 性能优化 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">RN</p><ul class="sidebar-sub-items"><li><!--[--><a href="/blog/Framework/RN/%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6.html" class="nav-link sidebar-item" aria-label="基本概念"><!--[--><!--]--> 基本概念 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/Framework/RN/%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.html" class="nav-link sidebar-item" aria-label="启动流程"><!--[--><!--]--> 启动流程 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/Framework/RN/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html" class="nav-link sidebar-item" aria-label="性能优化"><!--[--><!--]--> 性能优化 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/Framework/RN/%E6%96%B0%E6%9E%B6%E6%9E%84.html" class="nav-link sidebar-item" aria-label="新架构"><!--[--><!--]--> 新架构 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Flutter</p><ul class="sidebar-sub-items"><li><!--[--><a href="/blog/Framework/Flutter/%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86.html" class="nav-link sidebar-item" aria-label="核心原理"><!--[--><!--]--> 核心原理 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/Framework/Flutter/UI%E7%B3%BB%E7%BB%9F.html" class="nav-link sidebar-item" aria-label="UI系统"><!--[--><!--]--> UI系统 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="运行机制" tabindex="-1"><a class="header-anchor" href="#运行机制" aria-hidden="true">#</a> 运行机制</h1><h2 id="一、技术选型" tabindex="-1"><a class="header-anchor" href="#一、技术选型" aria-hidden="true">#</a> 一、技术选型</h2><p>一般来说，渲染界面的技术有三种：</p><ul><li><strong>用纯客户端原生技术来渲染</strong></li><li><strong>用纯 Web 技术来渲染</strong></li><li><strong>用客户端原生技术与 Web 技术结合的混合技术（简称 Hybrid 技术）来渲染</strong></li></ul><p>通过以下几个方面分析，小程序采用哪种技术方案</p><ul><li><strong>开发门槛：Web 门槛低，Native 也有像 RN 这样的框架支持</strong></li><li><strong>体验：Native 体验比 Web 要好太多，Hybrid 在一定程度上比 Web 接近原生体验</strong></li><li><strong>版本更新：Web 支持在线更新，Native 则需要打包到微信一起审核发布</strong></li><li><strong>管控和安全：Web 可跳转或是改变页面内容，存在一些不可控因素和安全风险</strong></li></ul><p><strong>最终采用了两者结合起来的Hybrid 技术来渲染小程序，可以用一种近似web的方式来开发，并且可以实现在线更新代码，同时引入组件也有以下好处：</strong></p><ul><li><strong>扩展 Web 的能力。比如像输入框组件（input, textarea）有更好地控制键盘的能力</strong></li><li><strong>体验更好，同时也减轻 WebView 的渲染工作</strong></li><li><strong>绕过 setData、数据通信和重渲染流程，使渲染性能更好</strong></li><li><strong>用客户端原生渲染内置一些复杂组件，可以提供更好的性能</strong></li></ul><h3 id="jsbridge-的用途" tabindex="-1"><a class="header-anchor" href="#jsbridge-的用途" aria-hidden="true">#</a> JSBridge 的用途</h3><p>JSBridge 简单来讲，主要是 <strong>给 JavaScript 提供调用 Native 功能的接口</strong>，让混合开发中的『前端部分』可以方便地使用地址位置、摄像头甚至支付等 Native 功能。</p><h3 id="jsbridge-的实现原理" tabindex="-1"><a class="header-anchor" href="#jsbridge-的实现原理" aria-hidden="true">#</a> JSBridge 的实现原理</h3><p>JavaScript 是运行在一个单独的 JS Context 中（例如，WebView 的 Webkit 引擎、JSCore）。由于这些 Context 与原生运行环境的天然隔离，我们可以将这种情况与 RPC（Remote Procedure Call，远程过程调用）通信进行类比，将 Native 与 JavaScript 的每次互相调用看做一次 RPC 调用。</p><h3 id="javascript-调用-native" tabindex="-1"><a class="header-anchor" href="#javascript-调用-native" aria-hidden="true">#</a> JavaScript 调用 Native</h3><p>1.<strong>注入API</strong>:通过 WebView 提供的接口，<strong>向 JavaScript 的 Context（window）中注入对象或者方法，让 JavaScript 调用时，直接执行相应的 Native 代码逻辑</strong>，达到 JavaScript 调用 Native 的目的。</p><p>2.<strong>拦截 URL SCHEME</strong>:Web 端通过某种方式（例如 iframe.src）<strong>发送 URL Scheme 请求，之后 Native 拦截到请求并根据 URL SCHEME（包括所带的参数）进行相关操作</strong>。</p><p>URL SCHEME是一种类似于url的链接，是为了方便app直接互相调用设计的，形式和普通的 url 近似，主要区别是 protocol 和 host 一般是自定义的</p><h3 id="native-调用-javascript" tabindex="-1"><a class="header-anchor" href="#native-调用-javascript" aria-hidden="true">#</a> Native 调用 JavaScript</h3><p>Native 调用 JavaScript，其实就是<strong>执行拼接 JavaScript 字符串，从外部调用 JavaScript 中的方法</strong>，因此 JavaScript 的方法必须在全局的 window 上。</p><h3 id="编译文件" tabindex="-1"><a class="header-anchor" href="#编译文件" aria-hidden="true">#</a> 编译文件</h3><p>小程序编译后的结果会有<strong>两个bundle</strong>，index.js封装的是小程序项目的 view 层，以及 index.worker.js 封装的是项目的业务逻辑，在运行时，会有两条线程来分别处理这两个bundle，一个是<strong>主渲染线程</strong>，它负责加载并渲染 index.js 里的内容，另外一个是 <strong>Service Worker线程</strong>，它负责执行 index.worker.js 里封装的业务逻辑，这里面会有很多对底层api调用。</p><h2 id="二、双线程模型" tabindex="-1"><a class="header-anchor" href="#二、双线程模型" aria-hidden="true">#</a> 二、双线程模型</h2><p><strong>管控和安全</strong>：<strong>阻止开发者使用一些，例如浏览器的window对象，跳转页面、操作DOM、动态执行脚本的开放性接口。</strong></p><p><strong>视图层的界面使用了 WebView 进行渲染，逻辑层采用 JsCore 线程运行 JS脚本。</strong></p><ul><li><strong>逻辑层：创建一个单独的线程去执行 JavaScript，在这里执行的都是有关小程序业务逻辑的代码，负责逻辑处理、数据请求、接口调用等</strong></li><li><strong>视图层：界面渲染相关的任务全都在 WebView 线程里执行，通过逻辑层代码去控制渲染哪些界面。一个小程序存在多个界面，所以视图层存在多个 WebView 线程</strong></li><li><strong>JSBridge 起到架起上层开发与Native（系统层）的桥梁，使得小程序可通过API使用原生的功能，且部分组件为原生组件实现，从而有良好体验</strong></li></ul><h2 id="三、双线程通信" tabindex="-1"><a class="header-anchor" href="#三、双线程通信" aria-hidden="true">#</a> 三、双线程通信</h2><p>逻辑层和试图层的通信会由 <strong>Native （微信客户端）做中转</strong>，逻辑层发送网络请求也经由 Native 转发。</p><p><strong>这也就是说，我们可以把 DOM 的更新通过简单的数据通信来实现。</strong></p><p><strong>1. 在渲染层把 WXML 转化成对应的 JS 对象。</strong></p><p><strong>2. 在逻辑层发生数据变更的时候，通过宿主环境提供的 setData 方法把数据从逻辑层传递到 Native，再转发到渲染层。</strong></p><p><strong>3. 经过对比前后差异，把差异应用在原来的 DOM 树上，更新界面。</strong></p><h2 id="四、运行机制" tabindex="-1"><a class="header-anchor" href="#四、运行机制" aria-hidden="true">#</a> 四、运行机制</h2><ul><li>小程序没有重启的概念</li><li>当小程序进入后台，客户端会维持一段时间的运行状态，超过一定时间后（目前是5分钟）会被微信主动销毁</li><li>当短时间内（5s）连续收到两次以上收到系统内存告警，会进行小程序的销毁</li></ul><h2 id="五、性能优化" tabindex="-1"><a class="header-anchor" href="#五、性能优化" aria-hidden="true">#</a> 五、性能优化</h2><p>主要的优化策略可以归纳为三点：</p><ul><li><strong>精简代码，降低WXML结构和JS代码的复杂性；</strong></li><li><strong>合理使用setData调用，减少setData次数和数据量；</strong></li><li><strong>必要时使用分包优化。</strong></li></ul><p><strong>setData</strong>：即用户传输的数据，需要将其<strong>转换为字符串形式传递</strong>，同时把转换后的数据内容拼接成一份 JS 脚本，再通过<strong>执行 JS 脚本的形式</strong>传递到两边独立环境。</p><!--]--></div><footer class="page-meta"><!----><!----><!----></footer><nav class="page-nav"><p class="inner"><!----><span class="next"><a href="/blog/Framework/%E5%B0%8F%E7%A8%8B%E5%BA%8F/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html" class="nav-link" aria-label="性能优化"><!--[--><!--]--> 性能优化 <!--[--><!--]--></a> → </span></p></nav><!--[--><!--]--></main></div><!----><!--]--></div>
    <script src="/blog/assets/js/runtime~app.5b40ce10.js" defer></script><script src="/blog/assets/js/981.9765ac40.js" defer></script><script src="/blog/assets/js/app.3e27996d.js" defer></script>
  </body>
</html>
