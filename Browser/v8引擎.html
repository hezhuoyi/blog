<!DOCTYPE html>
<html lang="zh-US">
  <head>
    <link rel="manifest" href="/blog/manifest.webmanifest"><title>v8引擎 | Johnny's blog</title><meta name="description" content="认真分享和记录各类好文，逐步完善大前端知识体系。"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="VuePress 2.0.0-beta.22">
    <link rel="preload" href="/blog/assets/js/runtime~app.5b40ce10.js" as="script"><link rel="preload" href="/blog/assets/css/styles.678e5aee.css" as="style"><link rel="preload" href="/blog/assets/js/981.9765ac40.js" as="script"><link rel="preload" href="/blog/assets/js/app.3e27996d.js" as="script">
    <link rel="stylesheet" href="/blog/assets/css/styles.678e5aee.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><header class="navbar"><div class="toggle-sidebar-button"><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><span><a href="/blog/" class=""><!----><span class="site-name">Johnny&#39;s blog</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/blog/JavaScript/" class="nav-link" aria-label="深入JavaScript"><!--[--><!--]--> 深入JavaScript <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/Network/" class="nav-link" aria-label="计算机网络"><!--[--><!--]--> 计算机网络 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/Browser/" class="nav-link router-link-active" aria-label="浏览器相关"><!--[--><!--]--> 浏览器相关 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/Framework/" class="nav-link" aria-label="框架和类库"><!--[--><!--]--> 框架和类库 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/Engineering/" class="nav-link" aria-label="前端工程化"><!--[--><!--]--> 前端工程化 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/NewTechnology/" class="nav-link" aria-label="新技术/方向"><!--[--><!--]--> 新技术/方向 <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://hezhuoyi.github.io/leetcode" rel="noopener noreferrer" target="_blank" aria-label="LeetCode"><!--[--><!--]--> LeetCode <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/hezhuoyi" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://juejin.cn/user/3597257778155703" rel="noopener noreferrer" target="_blank" aria-label="掘金"><!--[--><!--]--> 掘金 <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="Search" autocomplete="off" spellcheck="false" value><!----></form></div></header><div class="sidebar-mask"></div><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/blog/JavaScript/" class="nav-link" aria-label="深入JavaScript"><!--[--><!--]--> 深入JavaScript <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/Network/" class="nav-link" aria-label="计算机网络"><!--[--><!--]--> 计算机网络 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/Browser/" class="nav-link router-link-active" aria-label="浏览器相关"><!--[--><!--]--> 浏览器相关 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/Framework/" class="nav-link" aria-label="框架和类库"><!--[--><!--]--> 框架和类库 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/Engineering/" class="nav-link" aria-label="前端工程化"><!--[--><!--]--> 前端工程化 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/NewTechnology/" class="nav-link" aria-label="新技术/方向"><!--[--><!--]--> 新技术/方向 <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://hezhuoyi.github.io/leetcode" rel="noopener noreferrer" target="_blank" aria-label="LeetCode"><!--[--><!--]--> LeetCode <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/hezhuoyi" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://juejin.cn/user/3597257778155703" rel="noopener noreferrer" target="_blank" aria-label="掘金"><!--[--><!--]--> 掘金 <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item active">浏览器相关</p><ul class=""><li><!--[--><a href="/blog/Browser/" class="nav-link router-link-active sidebar-item" aria-label="概览"><!--[--><!--]--> 概览 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/Browser/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86.html" class="nav-link sidebar-item" aria-label="浏览器工作原理"><!--[--><!--]--> 浏览器工作原理 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/Browser/%E6%B5%8F%E8%A7%88%E5%99%A8%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html" class="nav-link sidebar-item" aria-label="浏览器性能优化"><!--[--><!--]--> 浏览器性能优化 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/Browser/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98.html" class="nav-link sidebar-item" aria-label="浏览器缓存"><!--[--><!--]--> 浏览器缓存 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/Browser/%E4%BB%8E%E8%BE%93%E5%85%A5URL%E5%88%B0%E9%A1%B5%E9%9D%A2%E5%91%88%E7%8E%B0.html" class="nav-link sidebar-item" aria-label="从输入URL到页面呈现"><!--[--><!--]--> 从输入URL到页面呈现 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blog/Browser/v8%E5%BC%95%E6%93%8E.html" class="router-link-active router-link-exact-active nav-link router-link-active sidebar-item active" aria-label="v8引擎"><!--[--><!--]--> v8引擎 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/blog/Browser/v8%E5%BC%95%E6%93%8E.html#v8引擎出现的原因" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="v8引擎出现的原因"><!--[--><!--]--> v8引擎出现的原因 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blog/Browser/v8%E5%BC%95%E6%93%8E.html#javascript引擎" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="JavaScript引擎"><!--[--><!--]--> JavaScript引擎 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blog/Browser/v8%E5%BC%95%E6%93%8E.html#v8引擎-1" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="V8引擎"><!--[--><!--]--> V8引擎 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blog/Browser/v8%E5%BC%95%E6%93%8E.html#v8-怎么执行-javascript-代码的" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="V8 怎么执行 JavaScript 代码的"><!--[--><!--]--> V8 怎么执行 JavaScript 代码的 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blog/Browser/v8%E5%BC%95%E6%93%8E.html#解析器如何把源码转换成-ast" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="解析器如何把源码转换成 AST"><!--[--><!--]--> 解析器如何把源码转换成 AST <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blog/Browser/v8%E5%BC%95%E6%93%8E.html#v8-执行-javascript-的原理总结" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="V8 执行 JavaScript 的原理总结"><!--[--><!--]--> V8 执行 JavaScript 的原理总结 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blog/Browser/v8%E5%BC%95%E6%93%8E.html#v8-vs-javascriptcore" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="V8 VS JavaScriptCore"><!--[--><!--]--> V8 VS JavaScriptCore <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blog/Browser/v8%E5%BC%95%E6%93%8E.html#注意项" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="注意项"><!--[--><!--]--> 注意项 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="v8引擎" tabindex="-1"><a class="header-anchor" href="#v8引擎" aria-hidden="true">#</a> v8引擎</h1><h2 id="v8引擎出现的原因" tabindex="-1"><a class="header-anchor" href="#v8引擎出现的原因" aria-hidden="true">#</a> v8引擎出现的原因</h2><p>编译型语言： 在程序执行之前必须进行专门的编译过程，有如下特点：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>只须编译一次就可以把源代码编译成机器语言，后面的执行无须重新编译，直接使用之前的编译结果就可以；因此其执行的效率比较高；
编译性语言代表：C、C++、Java、Pascal/Object Pascal（Delphi）；
程序执行效率比较高，但比较依赖编译器，因此跨平台性差一些；
不同平台对编译器影响较大。
    16位系统下int是2个字节（16位），而32位系统下int占4个字节（32位）；
    32位系统下long类型占4字节，而64位系统下long类型占8个字节；
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>解释性语言 - 解释行语言，支持动态类型，弱类型，在程序运行的时候才进行编译，而编译前需要确定变量的类型，效率比较低，对不同系统平台有较大的兼容性.</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>源代码不能直接翻译成机器语言，而是先翻译成中间代码，再由解释器对中间代码进行解释运行；
    源代码—&gt;中间代码—&gt;机器语言
程序不需要编译，程序在运行时才翻译成机器语言，每执行一次都要翻译一次；
解释性语言代表：Python、JavaScript、Shell、Ruby、MATLAB等；
运行效率一般相对比较低，依赖解释器，跨平台性好；
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>比较：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>一般，编译性语言的运行效率比解释性语言更高；但是不能一概而论，部分解释性语言的解释器通过在运行时动态优化代码，甚至能使解释性语言的性能超过编译性语言；
编译性语言的跨平台特性比解释性语言差一些；
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>经过以上说明，解释性语言，运行效率低，随着Web相关技术的发展，JavaScript所要承担的工作也越来越多，早就超越了“表单验证”的范畴，这就更需要快速的解析和执行JavaScript脚本。V8引擎就是为解决这一问题而生，在node中也是采用该引擎来解析JavaScript。</p><h2 id="javascript引擎" tabindex="-1"><a class="header-anchor" href="#javascript引擎" aria-hidden="true">#</a> JavaScript引擎</h2><p>JavaScript本质上是一种解释型语言，与编译型语言不同的是它需要<strong>一边执行一边解析</strong>，而编译型语言在执行时已经完成编译，可直接执行，有更快的执行速度(如上图所示)。JavaScript代码是在浏览器端解析和执行的，如果需要时间太长，会影响用户体验。那么提高JavaScript的解析速度就是当务之急。</p><p>JavaScript语言是解释型语言，为了提高性能，引入了Java虚拟机和C++编译器中的众多技术。现在JavaScript引擎的执行过程大致是:</p><p>源代码-→抽象语法树-→字节码-→JIT-→本地代码(V8引擎没有中间字节码)。</p><p>V8更加直接的将抽象语法树通过JIT技术转换成本地代码，放弃了在字节码阶段可以进行的一些性能优化，但保证了执行速度。在V8生成本地代码后，也会通过Profiler采集一些信息，来优化本地代码。虽然，少了生成字节码这一阶段的性能优化，但极大减少了转换时间。</p><p>但是在2017年4月底，v8 的 5.9 版本发布了，新增了一个 Ignition 字节码解释器，将默认启动，从此之后将与JSCore有大致相同的流程。做出这一改变的原因为：（主要动机）减轻机器码占用的内存空间，即牺牲时间换空间；提高代码的启动速度；对 v8 的代码进行重构，降低 v8 的代码复杂度</p><h2 id="v8引擎-1" tabindex="-1"><a class="header-anchor" href="#v8引擎-1" aria-hidden="true">#</a> V8引擎</h2><ul><li>V8引擎是一个JavaScript引擎实现，最初由一些语言方面专家设计，后被谷歌收购，随后谷歌对其进行了开源。</li><li>V8使用C++开发，在运行JavaScript之前，相比其它的JavaScript的引擎转换成字节码或解释执行，V8将其编译成原生机器码（IA-32, x86-64, ARM, or MIPS CPUs），并且使用了如内联缓存（inline caching）等方法来提高性能。</li><li>有了这些功能，JavaScript程序在V8引擎下的运行速度媲美二进制程序。</li><li>V8支持众多操作系统，如windows、linux、android等，也支持其他硬件架构，如IA32,X64,ARM等，具有很好的可移植和跨平台特性。</li></ul><p>2017 年，V8 正式发布全新编译 pipeline，即用 Ignition 和 TurboFan 的组合，来编译执行代码，从 V8 5.9 版开始，早期的 Full-Codegen 和 Crankshaft 编译器不再用来执行 JavaScript。</p><p>其中，最核心的是三个模块：</p><ul><li>解析器（Parser）</li><li>解释器（Ignition）</li><li>优化编译器（TurboFan）</li></ul><p><img src="/blog/assets/img/v8-module.c4d2e1b8.jpeg" alt="v8-module"></p><h2 id="v8-怎么执行-javascript-代码的" tabindex="-1"><a class="header-anchor" href="#v8-怎么执行-javascript-代码的" aria-hidden="true">#</a> V8 怎么执行 JavaScript 代码的</h2><p>当 V8 执行 JavaScript 源码时，首先解析器会把源码解析为抽象语法树（Abstract Syntax Tree），解释器（Ignotion）再将 AST 翻译为字节码，一边解释一边执行。</p><p>在此过程中，解释器会记特定代码片段的运行次数，如果代码运行次数超过某个阈值，那么该段代码就被标记为热代码（hot code），并将运行信息反馈给优化编译器（TurboFan）。</p><p>优化编译器根据反馈信息，优化并编译字节码，最终生成优化后的机器码，这样当该段代码再次执行时，解释器就直接使用优化机器码执行，不用再次解释，大大提高了代码运行效率。</p><p>这种在运行时编译代码的技术也被称为 JIT（即时编译），通过JIT可以极大提升 JavaScript 代码的执行性能。</p><h2 id="解析器如何把源码转换成-ast" tabindex="-1"><a class="header-anchor" href="#解析器如何把源码转换成-ast" aria-hidden="true">#</a> 解析器如何把源码转换成 AST</h2><p>要让 V8 执行我们编写的源码，就要将源码转换成 V8 能理解的格式。</p><p>V8 会先把源码解析为一个抽象语法树（AST），这是用来表示源码的树形结构的对象，这个过程称为解析（Parsing），主要由 V8 的 Parser 模块实现。然后， V8 的解释器会把 AST 编译为字节码，一边解释一边执行。</p><p>解析和编译过程的性能非常重要，因为 V8 只有等编译完成后才能运行代码。</p><p><img src="/blog/assets/img/v8-work.1aa3feef.jpeg" alt="v8-work"> 整个解析过程可分为两部分。</p><ol><li>词法分析：将字符流转换为 tokens，字符流就是我们编写的一行行代码，token 是指语法上不能再分割的最小单位，可能是单个字符，也可能是字符串，图中的 Scanner 就是 V8 的词法分析器。</li><li>语法分析：根据语法规则，将 tokens 组成一个有嵌套层级的抽象语法结构树，这个树就是 AST，在此过程中，如果源码不符合语法规范，解析过程就会终止，并抛出语法错误。图中的 Parser 和 Pre-Parser 都是 V8 的语法分析器。</li></ol><h2 id="v8-执行-javascript-的原理总结" tabindex="-1"><a class="header-anchor" href="#v8-执行-javascript-的原理总结" aria-hidden="true">#</a> V8 执行 JavaScript 的原理总结</h2><ol><li>解析器将 JavaScript 源码解析为 AST，解析过程分为词法分析和语法分析，V8 通过预解析提升解析效率；</li><li>解释器 Ignition 根据 AST 生成字节码并执行。这个过程中会收集执行反馈信息，交给 TurboFan 进行优化编译；</li><li>TurboFan 根据 Ignition 收集的反馈信息，将字节码编译为优化后的机器码，后续 Ignition 用优化机器码代替字节码执行，进而提升性能。</li></ol><h2 id="v8-vs-javascriptcore" tabindex="-1"><a class="header-anchor" href="#v8-vs-javascriptcore" aria-hidden="true">#</a> V8 VS JavaScriptCore</h2><p>JavaScriptCore引擎是WebKit中默认的JavaScript引擎，也是苹果开源的一个项目，应用较为广泛。最初，性能不是很好，从2008年开始了一系列的优化，重新实现了编译器和字节码解释器，使得引擎的性能有较大的提升。随后内嵌缓存、基于正则表达式的JIT、简单的JIT及字节码解释器等技术引入进来，JavaScriptCore引擎也在不断的迭代和发展。</p><p>V8引擎自诞生之日起就以性能优化作为目标，引入了众多新技术，极大了带动了整个业界JavaScript引擎性能的快速发展。总的来说，V8引擎较为激进，青睐可以提高性能的新技术，而JavaScriptCore引擎较为稳健，渐进式的改变着自己的性能。</p><p>JavaScriptCore 的大致流程为：源代码-→抽象语法树-→字节码-→JIT-→本地代码。JavaScriptCore与V8有一些不同之处，其中最大的不同就是新增了字节码的中间表示，并加入了多层JIT编译器（如：简单JIT编译器、DFG JIT编译器、LLVM等）优化性能，不停的对本地代码进行优化。</p><p>还有就是在数据表示方面，V8在不同的机器上使用与机器位数相匹配的数据表示，而在JavaScriptCore中句柄都是使用64位表示，其可以表示更大范围的数字，所以即使在32位机器上，浮点类型同样可以保存在句柄中，不再需要访问堆中的数据，当也会占用更多的空间。</p><h2 id="注意项" tabindex="-1"><a class="header-anchor" href="#注意项" aria-hidden="true">#</a> 注意项</h2><p>结合上面对于V8引擎的介绍，我们在编程中应注意：</p><ul><li>类型。对于函数，JavaScript是一种动态类型语言，JavaScriptCore和V8都使用隐藏类和内嵌缓存来提高性能，为了保证缓存命中率，一个函数应该使用较少的数据类型；对于数组，应尽量存放相同类型的数据，这样就可以通过偏移位置来访问。</li><li>数据表示。简单类型数据（如整型）直接保存在句柄中，可以减少寻址时间和内存占用，如果可以使用整数表示的，尽量不要用浮点类型。</li><li>内存。虽然JavaScript语言会自己进行垃圾回收，但我们也应尽量做到及时回收不用的内存，对不再使用的对象设置为null或使用delete方法来删除(使用delete方法删除会触发隐藏类新建，需要更多的额外操作)。</li><li>优化回滚。在执行多次之后，不要出现修改对象类型的语句，尽量不要触发优化回滚，否则会大幅度降低代码的性能。</li><li>新机制。使用JavaScript引擎或者渲染引擎提供的新机制和新接口提高性能。</li></ul><!--]--></div><footer class="page-meta"><!----><!----><!----></footer><nav class="page-nav"><p class="inner"><span class="prev"> ← <a href="/blog/Browser/%E4%BB%8E%E8%BE%93%E5%85%A5URL%E5%88%B0%E9%A1%B5%E9%9D%A2%E5%91%88%E7%8E%B0.html" class="nav-link" aria-label="从输入URL到页面呈现"><!--[--><!--]--> 从输入URL到页面呈现 <!--[--><!--]--></a></span><!----></p></nav><!--[--><!--]--></main></div><!----><!--]--></div>
    <script src="/blog/assets/js/runtime~app.5b40ce10.js" defer></script><script src="/blog/assets/js/981.9765ac40.js" defer></script><script src="/blog/assets/js/app.3e27996d.js" defer></script>
  </body>
</html>
